<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>room standard 예약 페이지</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/style_hsf.css">
    <link rel="stylesheet" href="css/room_info.css">
    <script src="js/header.js" defer></script>
    <script src="js/footer.js" defer></script>
    <link href="assets/css/fontawesome.css" rel="stylesheet"/>
    <link href="assets/css/brands.css" rel="stylesheet"/>
    <link href="assets/css/solid.css" rel="stylesheet"/>
</head>
<body>
    <my-header></my-header>

    <div class="highlight-section_2">
        <div class="highlight-content_2">
            <h2>RESERVATION</h2>
            <p>실시간예약</p>
        </div>
    </div>

    <section id="reservation-info_1">
        <h3 id="room-title">STANDARD</h3>
    </section>

    <section class="reservation-content">
        <div class="image-view">
            <div class="swiper mainSwiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide"><img src="img/standard1.jpg" /></div>
                    <div class="swiper-slide"><img src="img/standard2.jpg" /></div>
                    <div class="swiper-slide"><img src="img/standard3.jpg" /></div>
                </div>
                </div>
                <div class="swiper thumbSwiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide"><img src="img/standard1.jpg" /></div>
                    <div class="swiper-slide"><img src="img/standard2.jpg" /></div>
                    <div class="swiper-slide"><img src="img/standard3.jpg" /></div>
                </div>
            </div>
        </div>

        <section class="room-description desc-mobile">
            <div class="desc-wrap">
                <p class="room-desc"></p>
                <p class="room-desc-eng"></p>
            </div>
        </section>

        <div class="calendar-section">
            <div id="calendar"></div>

            <div class="options">
                <label>추가 인원
                    <select id="extra-person">
                    <option value="0">없음</option>
                    <option value="1">1명</option>
                    <option value="2">2명</option>
                    </select>
                </label>
                <span class="note">기준 인원 2명, 추가 시 1인당 객실가의 20%</span>
            </div>

            <div class="total-price">
                <span>총 합계</span>
                <div class="price-wrap">
                    <strong id="total-price">150,000</strong>
                    <span class="unit">원</span>
                </div>
            </div>

            <div class="button-group">
                <button type="button" onclick="history.back()">취소</button>
                <button id="reserveBtn" class="reserve-btn" disabled>예약하기</button>
            </div>
        </div>
    </section>

    <section class="room-description desc-pc">
        <div class="desc-wrap">
            <p class="room-desc"></p>
            <p class="room-desc-eng"></p>
        </div>
    </section>

    <script src="js/calendar.js" defer></script>

    <my-footer></my-footer>

    <script>
        const thumbSwiper = new Swiper(".thumbSwiper", {
            spaceBetween: 10,
            slidesPerView: 'auto',
            watchSlidesProgress: true,
        });

        const mainSwiper = new Swiper(".mainSwiper", {
            spaceBetween: 10,
            thumbs: { swiper: thumbSwiper },
        });

        let roomId, prices, holidays, seasons, reservations;

        Promise.all([
            fetch('/api/rooms').then(res => res.json()),
            fetch('/api/prices').then(res => res.json()),
            fetch('/api/seasons').then(res => res.json()),
            fetch('/api/holidays').then(res => res.json()),
            fetch('/api/reservations').then(res => res.json())
        ]).then(([rooms, priceList, seasonList, holidayList, reservationList]) => {

            const room = rooms.find(r => r.name === "스탠다드");
            roomId = room.id;
            prices = priceList;
            holidays = holidayList.map(h => h.holidayDate || h.holiday_date);
            seasons = seasonList;
            reservations = reservationList.filter(r => (r.room?.id || r.room_id) === roomId);

            document.querySelectorAll(".room-desc").forEach(el => {
                el.textContent = room.description || room.desc;
            });
            document.querySelectorAll(".room-desc-eng").forEach(el => {
                el.textContent = room.descriptionEng || room.desc_eng;
            });

            document.getElementById("room-title").textContent = room.nameEng?.toUpperCase() || room.name_eng?.toUpperCase();

            const basePriceObj = prices.find(p => (p.room?.id || p.room_id) === roomId && (p.season?.id || p.season_id) === 1);
            const basePrice = basePriceObj ? (basePriceObj.weekdayPrice || basePriceObj.weekday_price) : 0;

            const reserved = reservations.flatMap(r => {
                const inDate = new Date(r.checkInDate || r.check_in_date);
                const outDate = new Date(r.checkOutDate || r.check_out_date);
                const dates = [];
                for (let d = new Date(inDate); d < outDate; d.setDate(d.getDate() + 1)) {
                    dates.push(d.toISOString().split('T')[0]);
                }
                return dates;
            });

            const priceDisplay = document.getElementById("total-price");
            const select = document.getElementById("extra-person");

            function updatePriceOnly() {
                const extra = parseInt(select.value);
                const final = basePrice + (extra * basePrice * 0.2);
                priceDisplay.textContent = final.toLocaleString();
            }

            select.addEventListener('change', () => {
                updatePriceOnly();
                calculateTotalPrice(roomId, seasons, holidays, prices, parseInt(select.value));
            });

            updatePriceOnly();

            renderCalendar(new Date().getFullYear(), new Date().getMonth(), reserved, holidays, seasons);

            document.getElementById('reserveBtn').addEventListener('click', () => {
                const checkIn = selectedCheckIn;
                const checkOut = selectedCheckOut;
                const extra = document.getElementById('extra-person').value;
                const totalPrice = document.getElementById('total-price').textContent;

                sessionStorage.setItem('reservation', JSON.stringify({
                    roomId,
                    roomName: room.name,
                    checkIn,
                    checkOut,
                    extra,
                    totalPrice
                }));

                alert(`예약 정보:\n입실: ${checkIn}\n퇴실: ${checkOut}\n추가 인원: ${extra}\n요금: ${totalPrice}원`);

                window.location.href = '/reserve_complete.html';
            });
        });
    </script>

</body>
</html>
